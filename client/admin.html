<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | THE RAS</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/modal.css">
    <link rel="stylesheet" href="/css/project.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet">
    <!-- SimpleMDE CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
     <style>
        .markdown-section {
            margin-top: 40px;
            background: rgba(255,255,255,0.05);
            padding: 25px;
            border-radius: 16px;
            backdrop-filter: blur (10px);
            border: 1px solid rgba(255,255,255,0.1);
            }

        .markdown-header {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 16px;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }        

        .markdown-actions {
            text-align: right;
            margin-top: 15px;
        }        

        #preview {
            margin-top: 20px;
            padding: 25px;
            background: #ffffff;
            border-radius: 12px;
            min-height: 200px;
            line-height: 1.6;
            font-size: 16px;
            box-shadow: 0px 5px 20px rgba(0,0,0,0.08);
        }        

        /* Better typography for rendered markdown */
        #preview h1, #preview h2, #preview h3 {
            font-weight: 700;
            margin-top: 20px;
        }        

        #preview ul {
            padding-left: 20px;
        }        

        #preview table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }        

        #preview table, #preview th, #preview td {
            border: 1px solid #ddd;
        }        

        #preview th, #preview td {
            padding: 10px;
        }        

        /* Button improvements */
        .btn.save-btn {
            background: #1E88E5;
            padding: 10px 18px;
            border-radius: 6px;
            transition: 0.2s;
        }        

        .btn.save-btn:hover {
            background: #1565C0;
        }        

        /* Fix SimpleMDE to match UI width */
        .CodeMirror, #editor {
            min-height: 300px !important;
            border-radius: 10px;
        }        

        .markdown-container {
            max-width: 800px;
            margin: auto;
        } 

    </style>
    <style>
    /* ... tumhari markdown wali CSS yahan tak hai ... */

    /* ========== Inbox / Messages Tab Styling ========== */

    #messages-tab {
        padding: 1.5rem 0;
    }

    #inbox-text h3 {
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--text-main);
    }

    /* Messages list container */
    .messages-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-height: 480px;
        overflow-y: auto;
        padding-right: 0.5rem;
        margin-top: 0.5rem;
    }

    /* Scrollbar */
    .messages-list::-webkit-scrollbar {
        width: 6px;
    }

    .messages-list::-webkit-scrollbar-thumb {
        background: var(--glass-border);
        border-radius: 999px;
    }

    .messages-list::-webkit-scrollbar-thumb:hover {
        background: var(--primary);
    }

    /* Message card (only in inbox, not everywhere) */
    #admin-messages .glass-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 0.9rem;
        transition: transform 0.2s ease, border-color 0.2s ease, background-color 0.2s ease;
    }

    #admin-messages .glass-card:hover {
        transform: translateY(-2px);
        border-color: var(--primary);
        background: rgba(255, 255, 255, 0.04);
    }

    /* Make top row align nicely */
    #admin-messages .flex-between {
        align-items: flex-start;
    }

    /* Paragraph inside message */
    #admin-messages p {
        line-height: 1.5;
    }

    /* ---------- Utility classes from your JS ---------- */

    .p-6 {
        padding: 1.5rem;
    }

    .mb-4 {
        margin-bottom: 1rem;
    }

    .mb-2 {
        margin-bottom: 0.5rem;
    }

    .mt-4 {
        margin-top: 1rem;
    }

    .text-white {
        color: #ffffff;
    }

    .text-primary {
        color: var(--primary);
    }

    .text-gray {
        color: var(--text-muted);
    }

    .text-sm {
        font-size: 0.875rem;
    }

    .text-xs {
        font-size: 0.75rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .messages-list {
            max-height: none;
        }

        #admin-messages .glass-card {
            padding: 1.25rem;
        }
    }

    /* ========== Admin Dashboard Specific Styles ========== */
    /* 2-Column Inbox Layout */
.inbox-wrapper {
    display: grid;
    grid-template-columns: 35% 1fr;
    height: 500px;
    gap: 1rem;
}

/* Message list scrollable */
.messages-list {
    overflow-y: auto;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    padding: .5rem;
}

/* Individual message item */
.message-item {
    padding: 1rem;
    border-radius: 10px;
    cursor: pointer;
    transition: all .2s;
    border: 1px solid transparent;
}

.message-item:hover {
    background: rgba(255,255,255,0.05);
}

.message-item.active {
    background: rgba(255,255,255,0.08);
    border-color: var(--primary);
}

/* Text inside message item */
.message-name {
    font-weight: 600;
    margin-bottom: 4px;
}

.message-email {
    color: var(--primary);
    font-size: 0.85rem;
}

.message-short {
    color: var(--text-muted);
    font-size: .8rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Right Side Full Message View */
#message-preview {
    border: 1px solid var(--glass-border);
    background: var(--glass-bg);
    padding: 1.5rem;
    border-radius: 10px;
    overflow-y: auto;
    color: var(--text-main);
}

#message-preview.empty {
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
}

/* Responsive (mobile switches to full page message mode) */
@media(max-width: 768px) {
    .inbox-wrapper {
        grid-template-columns: 1fr;
    }

    #message-preview {
        margin-top: 1rem;
    }
}

/* Improved Message Card UI (CSS Additions) */
.unread {
    font-weight: bold;
    border-left: 3px solid var(--primary);
}

.badge-count {
    background: var(--primary);
    padding: 2px 8px;
    font-size: 0.75rem;
    border-radius: 50px;
    margin-left: 8px;
}

</style>

</head>
<body>
    <nav class="navbar glass">
        <div class="container nav-container">
            <a href="/" class="logo">THE RAS<span class="dot">.</span></a>
            <div class="flex-center gap-4">
                <span class="badge">Admin Mode</span>
                <button id="logout-btn" class="btn btn-sm btn-danger"><i data-lucide="log-out"></i> Logout</button>
            </div>
        </div>
    </nav>

    <main class="pt-32 pb-20">
        <div class="container">
            <div class="dashboard-header mb-8">
                <h1>Dashboard</h1>
            </div>

            <div class="tabs">
                <button class="tab-btn active" data-tab="projects"><i data-lucide="layout"></i> Projects</button>
                <button class="tab-btn" data-tab="messages"><i data-lucide="mail"></i> Messages</button>
            </div>

            <div id="projects-tab" class="tab-content active">
                <div class="flex-between mb-6">
                    <h3>Manage Projects</h3>
                    <button id="add-project-btn" class="btn btn-primary btn-sm"><i data-lucide="plus"></i> Add Project</button>
                </div>
                <div class="admin-projects-list" id="admin-projects">
                    <!-- Loaded via JS -->
                </div>
            </div>

            <div id="messages-tab" class="tab-content">
                <div class="flex-between mb-6" id="inbox-text">
                    <h3>Inbox <span id="message-count" class="badge-count"></span></h3>
                
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="searchMessages" placeholder="Search..." 
                            style="padding:8px 14px;border-radius:8px;border:1px solid var(--glass-border);background:var(--glass-bg);color:white;">
                        
                        <select id="sortMessages" 
                            style="padding:8px 14px;border-radius:8px;border:1px solid var(--glass-border);background:var(--glass-bg);color:white;">
                            <option value="latest">Latest</option>
                            <option value="oldest">Oldest</option>
                        </select>
                    </div>
                </div>

            
                <div class="inbox-wrapper">
                 
                 <!-- Left Inbox List -->
                 <div class="messages-list" id="admin-messages">
                     <!-- Loaded via JS -->
                 </div>
            
                 <!-- Right Message Preview -->
                 <div id="message-preview" class="message-preview empty">
                     <p>Select a message to read.</p>
                 </div>
            
                </div>
            </div>

        </div>
    </main>

    <!-- Project Modal -->
    <div class="modal-overlay" id="project-modal">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <h3 id="modal-title">Add Project</h3>
                <button class="close-modal" id="close-modal">&times;</button>
            </div>
            <form id="project-form">
            
               <input type="hidden" id="project-id">
            
               <!-- Title -->
               <div class="form-group">
                   <label for="p-title">Project Title</label>
                   <input type="text" id="p-title" required placeholder="Project Name">
               </div>
            
               <!-- Short Description -->
               <div class="form-group">
                   <label for="p-desc">Short Description</label>
                   <textarea id="p-desc" required placeholder="Brief project summary..." style="min-height: 80px;"></textarea>
               </div>
            
               <!-- Markdown Editor -->
               <div class="markdown-container">
                   <h3 class="markdown-header">
                       <i data-lucide="edit"></i> Detailed Description (Markdown)
                   </h3>
                   
                   <textarea id="editor"></textarea>
            
                   <!-- Live Preview -->
                   <h3 class="markdown-header" style="margin-top:20px;">
                       <i data-lucide="eye"></i> Live Preview
                   </h3>
                   <div id="preview" class="markdown-preview">Start typing to see preview...</div>
               </div>
            
               <!-- Tech Stack -->
               <div class="form-group">
                   <label for="p-tech">Tech Stack (comma separated)</label>
                   <input type="text" id="p-tech" placeholder="React, Node.js, MongoDB">
               </div>
            
               <!-- Image URL -->
               <div class="form-group">
                   <label for="p-image">Image URL</label>
                   <input type="url" id="p-image" placeholder="https://example.com/image.jpg">
               </div>
               <div class="form-group">
                   <label for="p-githublink">GitHub Repo URL</label>
                   <input type="url" id="p-githublink" placeholder="git@github.com:username/repositoryname.git">
               </div>
            
               <!-- Submit -->
               <button type="submit" class="btn btn-primary w-full">Save Project</button>
            </form>
            
        </div>
    </div>
    <!-- SimpleMDE JavaScript -->
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    
    <!-- Marked.js for Markdown Preview -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script src="/js/mock-backend.js"></script>
    <script src="/js/main.js"></script>

    <script>
        lucide.createIcons();
        
        // Admin Guard
        (async () => {
            try {
                const res = await fetch(`/api/admin/isAdmin`, {
                method: "GET",
                credentials: "include"
                });

                if (!res.ok) {
                    window.location.href = "/login.html";
                }
            } catch (err) {
            window.location.href = "/login.html";
            }
        })();



        // logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        });




        // Tab Switching
        const tabs = document.querySelectorAll('.tab-btn');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
            });
        });


        let editorInstance = null;
        
        // Modal elements
        const modal = document.getElementById("project-modal");
        const projectForm = document.getElementById("project-form");
        const addProjectBtn = document.getElementById("add-project-btn");
        const closeModalBtn = document.getElementById("close-modal");
        
        // Create markdown editor only once
        function loadMarkdownEditor() {
            if (!editorInstance) {
                editorInstance = new SimpleMDE({
                    element: document.getElementById("editor"),
                    spellChecker: false,
                    placeholder: "Write detailed project description here..."
                });
        
                // Live preview sync
                editorInstance.codemirror.on("change", () => {
                    document.getElementById("preview").innerHTML = marked.parse(editorInstance.value());
                });
            }
        }
        
        // Open modal with add / edit mode
        function openModal(mode, project = null) {
        
            // Load editor only now (NOT on page load)
            loadMarkdownEditor();
        
            document.getElementById("modal-title").textContent =
                mode === "edit" ? "Edit Project" : "Add Project";
        
            if (project) {
                // Editing: fill values
                document.getElementById("project-id").value = project._id;
                document.getElementById("p-title").value = project.title;
                document.getElementById("p-desc").value = project.description;
                document.getElementById("p-tech").value = project.techStack.join(", ");
                document.getElementById("p-image").value = project.imageUrl;
                document.getElementById("p-githublink").value = project.githubLink;
        
                editorInstance.value(project.markdown || "");
                document.getElementById("preview").innerHTML = marked.parse(project.markdown || "");
        
            } else {
                // New project: reset everything
                projectForm.reset();
                editorInstance.value("");
                document.getElementById("preview").innerHTML = "Start typing to see preview...";
                document.getElementById("project-id").value = "";
            }
        
            modal.classList.add("active");
        }
        
        // Close modal
        function closeModal() {
            modal.classList.remove("active");
        }


        // Save form
       projectForm.addEventListener("submit", async (e) => {
            e.preventDefault();
        
            const projectId = document.getElementById("project-id").value;
        
            const newProjectData = {
                title: document.getElementById("p-title").value.trim(),
                description: document.getElementById("p-desc").value.trim(),
                markdown: editorInstance.value(),
                techStack: document.getElementById("p-tech").value.split(",")
                    .map(item => item.trim())
                    .filter(Boolean),
                imageUrl: document.getElementById("p-image").value || "https://via.placeholder.com/600x400",
                githubLink: document.getElementById("p-githublink").value || ""
            };
        
            try {
                const url = projectId ? `/api/projects/${projectId}` : `/api/projects`;
                const method = projectId ? "PUT" : "POST";
        
                const res = await fetch(url, {
                    method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(newProjectData)
                });
        
                if (!res.ok) throw new Error("Failed request");
        
                alert(projectId ? "Project Updated Successfully" : "Project Added Successfully");
        
                closeModal();
                loadProjects();
        
            } catch (error) {
                console.error(error);
                alert("Something went wrong!");
            }
        });
        
        
        // Button events
        addProjectBtn.addEventListener("click", () => openModal("add"));
        closeModalBtn.addEventListener("click", closeModal);
        
        // Close when clicking outside modal box
        modal.addEventListener("click", (e) => {
            if (e.target === modal) closeModal();
        });
        

        // Load projects

       async function loadProjects() {
            const res = await fetch("/api/projects");
            const projects = await res.json();
        
            const projectsContainer = document.getElementById("admin-projects");
            projectsContainer.innerHTML = projects.map(p => `
                <div class="project-card">
            
                    <img src="${p.imageUrl}" class="project-thumb" />
            
                    <div class="project-content">
                        <h2 class="project-title">${p.title}</h2>
                        <p class="project-desc">${p.description}</p>
                        <p class="project-tech">${p.techStack.join(", ")}</p>
            
                        <div class="project-buttons">
                            <button class="edit-btn" onclick='openModal("edit", ${JSON.stringify(p)})'>
                                <i data-lucide="edit"></i> Edit
                            </button>
                            <button class="delete-btn" onclick="deleteProject('${p._id}')">
                                <i data-lucide="trash"></i> Delete
                            </button>
                        </div>
                    </div>
            
                </div>
            `).join('');

            
            lucide.createIcons();
        }




    //    async function loadMessages() {
    //         const messages = await fetch("/api/contact").then(res => res.json());
    //         const container = document.getElementById("admin-messages");
            
    //         container.innerHTML = messages.map(m => `
    //             <div class="message-item" data-message='${JSON.stringify(m).replace(/'/g, "&apos;")}'>
    //                 <div class="message-name">${m.name}</div>
    //                 <div class="message-email">${m.email}</div>
    //                 <div class="message-short">${m.message}</div>
    //             </div>
    //         `).join("");
        
    //         // Click handler for preview
    //         document.querySelectorAll(".message-item").forEach(item => {
    //             item.addEventListener("click", () => {
                    
    //                 document.querySelectorAll(".message-item").forEach(i => i.classList.remove("active"));
    //                 item.classList.add("active");
        
    //                 const data = JSON.parse(item.dataset.message);
    //                 const preview = document.getElementById("message-preview");
    //                 preview.classList.remove("empty");
        
    //                 preview.innerHTML = `
    //                     <h2>${data.name}</h2>
    //                     <p class="text-primary mb-2">${data.email}</p>
    //                     <small class="text-gray">${new Date(data.createdAt).toLocaleString()}</small>
    //                     <hr style="margin:15px 0; border-color:rgba(255,255,255,0.1)">
    //                     <p>${data.message}</p>
    //                 `;
    //             });
    //         });
    //     }


         let GLOBAL_MESSAGES = [];
         let SELECTED_MESSAGE = null;

        async function loadMessages() {
        GLOBAL_MESSAGES = await fetch("/api/contact").then(res => res.json());
            
                renderMessages();
            }
            
            function renderMessages() {
                const searchValue = document.getElementById("searchMessages").value.toLowerCase();
                const sortValue = document.getElementById("sortMessages").value;
            
                let filtered = GLOBAL_MESSAGES
                    .filter(m => m.name.toLowerCase().includes(searchValue) || m.email.includes(searchValue) || m.message.toLowerCase().includes(searchValue));
            
                if (sortValue === "latest") filtered.reverse();
            
                document.getElementById("message-count").innerText = filtered.length;
            
                const container = document.getElementById("admin-messages");
            
                container.innerHTML = filtered.map(m => `
                    <div class="message-item ${m.status === 'unread' ? 'unread' : ''}" 
                         data-id="${m._id}">
                        <div class="message-name">${m.name}</div>
                        <div class="message-email">${m.email}</div>
                        <div class="message-short">${m.message}</div>
                    </div>
                `).join("");
            
                addMessageClickEvents();
            }
            
            function addMessageClickEvents(){
                document.querySelectorAll(".message-item").forEach(item => {
                    item.addEventListener("click", () => {
                        const id = item.dataset.id;
                        SELECTED_MESSAGE = GLOBAL_MESSAGES.find(m => m._id === id);
            
                        item.classList.remove("unread");
                        SELECTED_MESSAGE.status = "read";
            
                        showPreview();
                    });
                });
            }
            
            function showPreview(){
                const preview = document.getElementById("message-preview");
                const m = SELECTED_MESSAGE;
            
                preview.classList.remove("empty");
            
                preview.innerHTML = `
                    <h2>${m.name}</h2>
                    <p class="text-primary">${m.email}</p>
                    <small>${new Date(m.createdAt).toLocaleString()}</small>
                    <hr style="margin:15px 0;">
                    <p>${m.message}</p>
                    <br>
                    <button class="btn btn-primary" onclick="replyMessage('${m.email}')"><i data-lucide="mail"></i> Reply</button>
                    <button class="btn btn-danger" onclick="deleteMessage('${m._id}')"><i data-lucide="trash"></i> Delete</button>
                    <button class="btn btn-outline" onclick="markUnread('${m._id}')"><i data-lucide="eye-off"></i> Mark Unread</button>
                `;
            }
            
            document.getElementById("searchMessages").addEventListener("input", renderMessages);
            document.getElementById("sortMessages").addEventListener("change", renderMessages);
            


    
    //   Delete project
        async function deleteProject(id) {
            if (confirm("Are you sure?")) {
               await fetch(`/api/projects/${id}`, { method: "DELETE" });
               loadProjects();
            }
        }





        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadProjects();
            loadMessages();
        });

        function replyMessage(email){
            window.location.href = `mailto:${email}`;
        }
        
        async function deleteMessage(id){
            if(confirm("Delete message?")){
                await fetch(`/api/contact/${id}`, { method:"DELETE" });
                loadMessages();
            }
        }
        
        function markUnread(id){
            const msg = GLOBAL_MESSAGES.find(m => m._id === id);
            msg.status = "unread";
            renderMessages();
        }
        
    </script>
</body>
</html>