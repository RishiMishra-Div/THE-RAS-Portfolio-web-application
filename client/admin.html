<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Rishi</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/modal.css">
    <link rel="stylesheet" href="/css/project.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet">
    <!-- SimpleMDE CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
     <style>
        .markdown-section {
            margin-top: 40px;
            background: rgba(255,255,255,0.05);
            padding: 25px;
            border-radius: 16px;
            backdrop-filter: blur (10px);
            border: 1px solid rgba(255,255,255,0.1);
            }

        .markdown-header {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 16px;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }        

        .markdown-actions {
            text-align: right;
            margin-top: 15px;
        }        

        #preview {
            margin-top: 20px;
            padding: 25px;
            background: #ffffff;
            border-radius: 12px;
            min-height: 200px;
            line-height: 1.6;
            font-size: 16px;
            box-shadow: 0px 5px 20px rgba(0,0,0,0.08);
        }        

        /* Better typography for rendered markdown */
        #preview h1, #preview h2, #preview h3 {
            font-weight: 700;
            margin-top: 20px;
        }        

        #preview ul {
            padding-left: 20px;
        }        

        #preview table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }        

        #preview table, #preview th, #preview td {
            border: 1px solid #ddd;
        }        

        #preview th, #preview td {
            padding: 10px;
        }        

        /* Button improvements */
        .btn.save-btn {
            background: #1E88E5;
            padding: 10px 18px;
            border-radius: 6px;
            transition: 0.2s;
        }        

        .btn.save-btn:hover {
            background: #1565C0;
        }        

        /* Fix SimpleMDE to match UI width */
        .CodeMirror, #editor {
            min-height: 300px !important;
            border-radius: 10px;
        }        

        .markdown-container {
            max-width: 800px;
            margin: auto;
        } 

    </style>
</head>
<body>
    <nav class="navbar glass">
        <div class="container nav-container">
            <a href="/" class="logo">Rishi<span class="dot">.</span></a>
            <div class="flex-center gap-4">
                <span class="badge">Admin Mode</span>
                <button id="logout-btn" class="btn btn-sm btn-danger"><i data-lucide="log-out"></i> Logout</button>
            </div>
        </div>
    </nav>

    <main class="pt-32 pb-20">
        <div class="container">
            <div class="dashboard-header mb-8">
                <h1>Dashboard</h1>
            </div>

            <div class="tabs">
                <button class="tab-btn active" data-tab="projects"><i data-lucide="layout"></i> Projects</button>
                <button class="tab-btn" data-tab="messages"><i data-lucide="mail"></i> Messages</button>
            </div>

            <div id="projects-tab" class="tab-content active">
                <div class="flex-between mb-6">
                    <h3>Manage Projects</h3>
                    <button id="add-project-btn" class="btn btn-primary btn-sm"><i data-lucide="plus"></i> Add Project</button>
                </div>
                <div class="admin-projects-list" id="admin-projects">
                    <!-- Loaded via JS -->
                </div>
            </div>

            <div id="messages-tab" class="tab-content">
                <div class="flex-between mb-6">
                    <h3>Inbox</h3>
                </div>
                <div class="messages-list" id="admin-messages">
                    <!-- Loaded via JS -->
                </div>
            </div>
        </div>
    </main>

    <!-- Project Modal -->
    <div class="modal-overlay" id="project-modal">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <h3 id="modal-title">Add Project</h3>
                <button class="close-modal" id="close-modal">&times;</button>
            </div>
            <form id="project-form">
            
               <input type="hidden" id="project-id">
            
               <!-- Title -->
               <div class="form-group">
                   <label for="p-title">Project Title</label>
                   <input type="text" id="p-title" required placeholder="Project Name">
               </div>
            
               <!-- Short Description -->
               <div class="form-group">
                   <label for="p-desc">Short Description</label>
                   <textarea id="p-desc" required placeholder="Brief project summary..." style="min-height: 80px;"></textarea>
               </div>
            
               <!-- Markdown Editor -->
               <div class="markdown-container">
                   <h3 class="markdown-header">
                       <i data-lucide="edit"></i> Detailed Description (Markdown)
                   </h3>
                   
                   <textarea id="editor"></textarea>
            
                   <!-- Live Preview -->
                   <h3 class="markdown-header" style="margin-top:20px;">
                       <i data-lucide="eye"></i> Live Preview
                   </h3>
                   <div id="preview" class="markdown-preview">Start typing to see preview...</div>
               </div>
            
               <!-- Tech Stack -->
               <div class="form-group">
                   <label for="p-tech">Tech Stack (comma separated)</label>
                   <input type="text" id="p-tech" placeholder="React, Node.js, MongoDB">
               </div>
            
               <!-- Image URL -->
               <div class="form-group">
                   <label for="p-image">Image URL</label>
                   <input type="url" id="p-image" placeholder="https://example.com/image.jpg">
               </div>
            
               <!-- Submit -->
               <button type="submit" class="btn btn-primary w-full">Save Project</button>
            </form>
            
        </div>
    </div>
    <!-- SimpleMDE JavaScript -->
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    
    <!-- Marked.js for Markdown Preview -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script src="/js/mock-backend.js"></script>
    <script src="/js/main.js"></script>

    <script>
        lucide.createIcons();
        
        // Admin Guard
        (async () => {
            try {
                const res = await fetch(`/api/admin/isAdmin`, {
                method: "GET",
                credentials: "include"
                });

                if (!res.ok) {
                    window.location.href = "/login.html";
                }
            } catch (err) {
            window.location.href = "/login.html";
            }
        })();



        // logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        });




        // Tab Switching
        const tabs = document.querySelectorAll('.tab-btn');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
            });
        });


        let editorInstance = null;
        
        // Modal elements
        const modal = document.getElementById("project-modal");
        const projectForm = document.getElementById("project-form");
        const addProjectBtn = document.getElementById("add-project-btn");
        const closeModalBtn = document.getElementById("close-modal");
        
        // Create markdown editor only once
        function loadMarkdownEditor() {
            if (!editorInstance) {
                editorInstance = new SimpleMDE({
                    element: document.getElementById("editor"),
                    spellChecker: false,
                    placeholder: "Write detailed project description here..."
                });
        
                // Live preview sync
                editorInstance.codemirror.on("change", () => {
                    document.getElementById("preview").innerHTML = marked.parse(editorInstance.value());
                });
            }
        }
        
        // Open modal with add / edit mode
        function openModal(mode, project = null) {
        
            // Load editor only now (NOT on page load)
            loadMarkdownEditor();
        
            document.getElementById("modal-title").textContent =
                mode === "edit" ? "Edit Project" : "Add Project";
        
            if (project) {
                // Editing: fill values
                document.getElementById("project-id").value = project.id;
                document.getElementById("p-title").value = project.title;
                document.getElementById("p-desc").value = project.description;
                document.getElementById("p-tech").value = project.techStack.join(", ");
                document.getElementById("p-image").value = project.imageUrl;
        
                editorInstance.value(project.markdown || "");
                document.getElementById("preview").innerHTML = marked.parse(project.markdown || "");
        
            } else {
                // New project: reset everything
                projectForm.reset();
                editorInstance.value("");
                document.getElementById("preview").innerHTML = "Start typing to see preview...";
                document.getElementById("project-id").value = "";
            }
        
            modal.classList.add("active");
        }
        
        // Close modal
        function closeModal() {
            modal.classList.remove("active");
        }


        // Save form
        projectForm.addEventListener("submit", async (e) => {
            e.preventDefault();
        
            const projectId = document.getElementById("project-id").value;
        
            const newProjectData = {
                title: document.getElementById("p-title").value.trim(),
                description: document.getElementById("p-desc").value.trim(),
                markdown: editorInstance.value(),
                techStack: document.getElementById("p-tech").value.split(",").map(item => item.trim()),
                imageUrl: document.getElementById("p-image").value || "https://via.placeholder.com/600x400"
            };
        
            
            // Decide between add or edit
            if (projectId) {
                await fetch(`/api/projects/${projectId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(newProjectData)
                });
            } else {
                await fetch(`/api/projects`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(newProjectData)
                });
            }

        
            closeModal();
            loadProjects(); // refresh UI
        });
        
        // Button events
        addProjectBtn.addEventListener("click", () => openModal("add"));
        closeModalBtn.addEventListener("click", closeModal);
        
        // Close when clicking outside modal box
        modal.addEventListener("click", (e) => {
            if (e.target === modal) closeModal();
        });
        

        // Load projects

       async function loadProjects() {
            const res = await fetch("/api/projects");
            const projects = await res.json();
        
            const projectsContainer = document.getElementById("admin-projects");
            projectsContainer.innerHTML = projects.map(p => `
                <div class="project-card">
            
                    <img src="${p.imageUrl}" class="project-thumb" />
            
                    <div class="project-content">
                        <h2 class="project-title">${p.title}</h2>
                        <p class="project-desc">${p.description}</p>
                        <p class="project-tech">${p.techStack.join(", ")}</p>
            
                        <div class="project-buttons">
                            <button class="edit-btn" onclick='openModal("edit", ${JSON.stringify(p)})'>
                                <i data-lucide="edit"></i> Edit
                            </button>
                            <button class="delete-btn" onclick="deleteProject('${p._id}')">
                                <i data-lucide="trash"></i> Delete
                            </button>
                        </div>
                    </div>
            
                </div>
            `).join('');

            
            lucide.createIcons();
        }




        async function loadMessages() {
            const messages = await mockApi.messages.getAll();
            const messagesContainer = document.getElementById('admin-messages');
            messagesContainer.innerHTML = messages.map(m => `
                <div class="glass-card p-6 mb-4">
                    <div class="flex-between mb-2">
                        <div>
                            <h4 class="text-white">${m.name}</h4>
                            <p class="text-primary text-sm">${m.email}</p>
                        </div>
                        <span class="text-xs text-gray">${new Date(m.createdAt).toLocaleDateString()}</span>
                    </div>
                    <p class="text-gray mt-4">${m.message}</p>
                </div>
            `).join('');
        }




    
    //   Delete project
        async function deleteProject(id) {
            if (confirm("Are you sure?")) {
               await fetch(`/api/projects/${id}`, { method: "DELETE" });
               loadProjects();
            }
        }





        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadProjects();
            loadMessages();
        });
    </script>
</body>
</html>